<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de KPIs - ManiGrab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;700&display=swap" rel="stylesheet"/>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#ffd700',
            'bg-dark': '#0B132B',
            'card-dark': '#1C2541',
            success: '#4CAF50',
            alert: '#FF6B6B',
            info: '#2196F3',
          },
          fontFamily: { display: ['Manrope', 'sans-serif'] },
        },
      },
    };
  </script>
  <style>
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'opsz' 24; }
    body { font-family: 'Manrope', sans-serif; }
  </style>
</head>
<body class="bg-bg-dark text-white font-display min-h-screen antialiased">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-50 flex items-center justify-between border-b border-slate-700 bg-bg-dark/95 backdrop-blur px-6 py-3">
      <div class="flex items-center gap-3 text-primary">
        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 48 48"><path d="M24 0L47.2 24L24 47.2L0.8 24L24 0.8V0zm0 12L12 24l12 12 12-12L24 12z"/></svg>
        <h1 class="text-xl font-extrabold tracking-tight">ManiGrab</h1>
      </div>
      <nav class="flex flex-wrap items-center gap-4 text-sm">
        <a href="#resumen" class="text-slate-400 hover:text-primary transition-colors">Resumen</a>
        <a href="#engagement" class="text-slate-400 hover:text-primary transition-colors">Engagement</a>
        <a href="#suscripciones" class="text-slate-400 hover:text-primary transition-colors">Suscripciones</a>
        <a href="#calidad" class="text-slate-400 hover:text-primary transition-colors">Calidad e IA</a>
        <a href="#desafios" class="text-slate-400 hover:text-primary transition-colors">Desafíos</a>
        <a href="#recompensas" class="text-slate-400 hover:text-primary transition-colors">Recompensas</a>
        <a href="#diario" class="text-slate-400 hover:text-primary transition-colors">Diario</a>
      </nav>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full px-6 py-8 space-y-12">
      <!-- ========== SECCIÓN 1: RESUMEN EJECUTIVO ========== -->
      <section id="resumen" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Resumen Ejecutivo</h2>
        <p class="text-slate-400 text-sm mb-6">KPIs principales y vista general de rendimiento</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Total usuarios</p>
            <p class="text-3xl font-bold mt-1" data-kpi="resumen.totalUsers">—</p>
            <p class="text-slate-500 text-xs mt-2">Registrados en la app</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Suscripciones Activas</p>
            <p class="text-3xl font-bold mt-1" data-kpi="resumen.activeSubscriptions">—</p>
            <p class="text-slate-500 text-xs mt-2">Vigentes (expires_at &gt; hoy)</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Plan anual</p>
            <p class="text-3xl font-bold text-primary mt-1" data-kpi="resumen.yearlyCount">—</p>
            <p class="text-slate-500 text-xs mt-2">Suscripciones anuales</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Plan mensual</p>
            <p class="text-3xl font-bold mt-1" data-kpi="resumen.monthlyCount">—</p>
            <p class="text-slate-500 text-xs mt-2">Suscripciones mensuales</p>
          </div>
        </div>
        <div class="mt-6 bg-card-dark rounded-xl p-6 border border-slate-700">
          <h3 class="text-lg font-bold mb-4">Nuevos Usuarios vs. Ingresos (últimos 30 días)</h3>
          <div class="flex flex-wrap gap-8 mb-4">
            <div><p class="text-primary text-2xl font-bold">$45,200</p><p class="text-slate-500 text-xs uppercase font-bold">Ingresos</p></div>
            <div><p class="text-white text-2xl font-bold">3,842</p><p class="text-slate-500 text-xs uppercase font-bold">Nuevos usuarios</p></div>
          </div>
          <div class="h-48 flex items-end gap-1">
            <div class="flex-1 bg-primary/30 rounded-t min-h-[20%]" style="height:45%"></div>
            <div class="flex-1 bg-primary/50 rounded-t min-h-[20%]" style="height:60%"></div>
            <div class="flex-1 bg-primary/40 rounded-t min-h-[20%]" style="height:50%"></div>
            <div class="flex-1 bg-primary rounded-t min-h-[20%]" style="height:75%"></div>
            <div class="flex-1 bg-primary/60 rounded-t min-h-[20%]" style="height:55%"></div>
            <div class="flex-1 bg-primary/80 rounded-t min-h-[20%]" style="height:85%"></div>
            <div class="flex-1 bg-primary rounded-t min-h-[20%]" style="height:70%"></div>
          </div>
          <div class="flex justify-between text-slate-500 text-xs mt-2 px-1">Día 1 · Día 7 · Día 14 · Día 21 · Día 30</div>
        </div>
        <div class="mt-6 p-4 rounded-xl bg-slate-800/50 border border-slate-700">
          <h4 class="font-bold text-primary flex items-center gap-2 mb-3"><span class="material-symbols-outlined">notifications</span> Alertas recientes</h4>
          <ul class="space-y-2 text-sm">
            <li class="flex gap-3 p-2 rounded-lg bg-alert/10 border-l-4 border-alert"><span class="material-symbols-outlined text-alert">warning</span><span>3 reportes de calidad pendientes</span></li>
            <li class="flex gap-3 p-2 rounded-lg bg-primary/10 border-l-4 border-primary"><span class="material-symbols-outlined text-primary">trending_down</span><span>Pico en tasa de cancelación (últimas 24h)</span></li>
            <li class="flex gap-3 p-2 rounded-lg bg-success/10 border-l-4 border-success"><span class="material-symbols-outlined text-success">verified</span><span>Hito de interacción ManiGrab 2.0 alcanzado</span></li>
          </ul>
        </div>
      </section>

      <!-- ========== SECCIÓN 2: ENGAGEMENT ========== -->
      <section id="engagement" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Engagement de Usuarios</h2>
        <p class="text-slate-400 text-sm mb-6">Sesiones, repeticiones y tiempo en app</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Sesiones de pilotaje hoy</p>
            <p class="text-2xl font-bold mt-1" data-kpi="engagement.sessionsToday">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Repeticiones totales</p>
            <p class="text-2xl font-bold mt-1" data-kpi="engagement.repetitionsTotal">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Total usuarios</p>
            <p class="text-2xl font-bold mt-1" data-kpi="resumen.totalUsers">—</p>
          </div>
        </div>
        <div class="mt-6 bg-card-dark rounded-xl p-6 border border-slate-700">
          <h3 class="text-lg font-bold mb-4">Sesiones de pilotaje y repeticiones (últimos 7 días)</h3>
          <div class="flex items-end justify-between h-48 gap-2">
            <div class="flex-1 flex flex-col items-center gap-1"><div class="w-full bg-slate-600 rounded-t" style="height:45%"></div><div class="w-full bg-primary rounded-t" style="height:60%"></div><span class="text-xs text-slate-500">Lun</span></div>
            <div class="flex-1 flex flex-col items-center gap-1"><div class="w-full bg-slate-600 rounded-t" style="height:55%"></div><div class="w-full bg-primary rounded-t" style="height:75%"></div><span class="text-xs text-slate-500">Mar</span></div>
            <div class="flex-1 flex flex-col items-center gap-1"><div class="w-full bg-slate-600 rounded-t" style="height:40%"></div><div class="w-full bg-primary rounded-t" style="height:50%"></div><span class="text-xs text-slate-500">Mié</span></div>
            <div class="flex-1 flex flex-col items-center gap-1"><div class="w-full bg-slate-600 rounded-t" style="height:60%"></div><div class="w-full bg-primary rounded-t" style="height:85%"></div><span class="text-xs text-slate-500">Jue</span></div>
            <div class="flex-1 flex flex-col items-center gap-1"><div class="w-full bg-slate-600 rounded-t" style="height:50%"></div><div class="w-full bg-primary rounded-t" style="height:65%"></div><span class="text-xs text-slate-500">Vie</span></div>
            <div class="flex-1 flex flex-col items-center gap-1"><div class="w-full bg-slate-600 rounded-t" style="height:70%"></div><div class="w-full bg-primary rounded-t" style="height:95%"></div><span class="text-xs text-slate-500">Sáb</span></div>
            <div class="flex-1 flex flex-col items-center gap-1"><div class="w-full bg-slate-600 rounded-t" style="height:65%"></div><div class="w-full bg-primary rounded-t" style="height:90%"></div><span class="text-xs text-slate-500">Dom</span></div>
          </div>
          <div class="flex gap-4 mt-3 text-xs"><span class="flex items-center gap-1"><span class="w-3 h-3 bg-primary rounded-sm"></span> Sesiones</span><span class="flex items-center gap-1"><span class="w-3 h-3 bg-slate-600 rounded-sm"></span> Repeticiones</span></div>
        </div>
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700"><h3 class="font-bold">Top 5 códigos más usados</h3></div>
            <table class="w-full text-sm">
              <thead class="text-slate-400 text-xs uppercase bg-slate-800/50"><tr><th class="px-4 py-2 text-left">#</th><th class="px-4 py-2 text-left">Código</th><th class="px-4 py-2 text-right">Uso</th></tr></thead>
              <tbody id="tbody-top-codigos" class="divide-y divide-slate-700">
                <tr><td colspan="3" class="px-4 py-3 text-slate-500 text-center">Cargando…</td></tr>
              </tbody>
            </table>
          </div>
          <div class="bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700"><h3 class="font-bold">Top códigos en favoritos</h3></div>
            <table class="w-full text-sm">
              <thead class="text-slate-400 text-xs uppercase bg-slate-800/50"><tr><th class="px-4 py-2 text-left">Código</th><th class="px-4 py-2 text-left">Categoría</th><th class="px-4 py-2 text-right">Favoritos</th></tr></thead>
              <tbody id="tbody-top-favoritos" class="divide-y divide-slate-700">
                <tr><td colspan="3" class="px-4 py-3 text-slate-500 text-center">Cargando…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ========== SECCIÓN 3: SUSCRIPCIONES E INGRESOS ========== -->
      <section id="suscripciones" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Suscripciones e Ingresos</h2>
        <p class="text-slate-400 text-sm mb-6">MRR, ARR, conversión y distribución</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Suscripciones activas</p>
            <p class="text-3xl font-bold text-primary mt-1" data-kpi="resumen.activeSubscriptions">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Plan anual</p>
            <p class="text-3xl font-bold mt-1" data-kpi="resumen.yearlyCount">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Plan mensual</p>
            <p class="text-3xl font-bold mt-1" data-kpi="resumen.monthlyCount">—</p>
          </div>
        </div>
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-card-dark rounded-xl p-6 border border-slate-700">
            <h3 class="text-lg font-bold mb-4">Distribución de suscripciones</h3>
            <div class="flex items-center gap-8">
              <div class="relative w-40 h-40 flex-shrink-0">
                <svg class="w-full h-full -rotate-90"><circle cx="80" cy="80" r="70" fill="none" stroke="#334155" stroke-width="16"/><circle id="circle-subscriptions" cx="80" cy="80" r="70" fill="none" stroke="#ffd700" stroke-dasharray="440" stroke-dashoffset="132" stroke-width="16"/></svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center"><span class="text-2xl font-bold" data-kpi="resumen.activeSubscriptions">—</span><span class="text-xs text-slate-500">Activos</span></div>
              </div>
              <div class="space-y-2">
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-primary"></span><span class="text-sm">Anual: <span data-kpi="resumen.yearlyCount">—</span></span></div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-600"></span><span class="text-sm">Mensual: <span data-kpi="resumen.monthlyCount">—</span></span></div>
              </div>
            </div>
          </div>
          <div class="bg-card-dark rounded-xl p-6 border border-slate-700">
            <h3 class="text-lg font-bold mb-4">Embudo: Gratuito → Premium</h3>
            <p class="text-slate-400 text-sm mb-4">Tasa de conversión: 6.8%</p>
            <div class="space-y-3">
              <div><div class="flex justify-between text-xs text-slate-500 mb-1"><span>Usuarios gratuitos</span><span>10,000</span></div><div class="h-6 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-primary/40 rounded-full w-full"></div></div></div>
              <div><div class="flex justify-between text-xs text-slate-500 mb-1"><span>Inicios de prueba</span><span>1,200</span></div><div class="h-6 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-primary/70 rounded-full w-[12%] min-w-[60px]"></div></div></div>
              <div><div class="flex justify-between text-xs text-slate-500 mb-1"><span>Premium</span><span>680</span></div><div class="h-6 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-primary rounded-full w-[6.8%] min-w-[50px]"></div></div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ========== SECCIÓN 4: CALIDAD DE CONTENIDO E IA ========== -->
      <section id="calidad" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Calidad de Contenido e IA</h2>
        <p class="text-slate-400 text-sm mb-6">Búsquedas IA, sugerencias y reportes</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700 text-center">
            <div class="inline-flex items-center justify-center w-24 h-24 rounded-full border-4 border-primary/50 mb-3"><span class="text-2xl font-black" data-kpi="calidad.tasaExitoIA">—</span><span class="text-sm">%</span></div>
            <p class="text-sm font-semibold">Tasa de éxito búsqueda IA</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700 text-center">
            <div class="inline-flex items-center justify-center w-24 h-24 rounded-full border-4 border-primary/50 mb-3"><span class="text-2xl font-black" data-kpi="calidad.latenciaMedia">—</span><span class="text-sm">ms</span></div>
            <p class="text-sm font-semibold">Latencia media (ms)</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700 text-center">
            <div class="inline-flex items-center justify-center w-24 h-24 rounded-full border-4 border-primary/50 mb-3"><span class="text-2xl font-black" data-kpi="calidad.costoTokens">—</span><span class="text-sm"> USD</span></div>
            <p class="text-sm font-semibold">Costo tokens</p>
          </div>
        </div>
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
              <h3 class="font-bold">Sugerencias pendientes</h3>
              <span class="bg-alert/20 text-alert text-xs font-bold px-2 py-0.5 rounded-full" data-kpi="calidad.sugerenciasPendientes">0</span>
            </div>
            <table class="w-full text-sm">
              <thead class="text-slate-400 text-xs uppercase bg-slate-800/50"><tr><th class="px-4 py-2 text-left">Código</th><th class="px-4 py-2 text-left">Tema sugerido</th></tr></thead>
              <tbody id="tbody-sugerencias" class="divide-y divide-slate-700">
                <tr><td colspan="2" class="px-4 py-3 text-slate-500 text-center">Cargando…</td></tr>
              </tbody>
            </table>
          </div>
          <div class="bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
              <h3 class="font-bold">Reportes de usuarios</h3>
              <span class="bg-alert/20 text-alert text-xs font-bold px-2 py-0.5 rounded-full" data-kpi="calidad.reportesPendientes">0</span>
            </div>
            <table class="w-full text-sm">
              <thead class="text-slate-400 text-xs uppercase bg-slate-800/50"><tr><th class="px-4 py-2 text-left">Código</th><th class="px-4 py-2 text-left">Tipo</th><th class="px-4 py-2 text-right">Estado</th></tr></thead>
              <tbody id="tbody-reportes" class="divide-y divide-slate-700">
                <tr><td colspan="3" class="px-4 py-3 text-slate-500 text-center">Cargando…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ========== SECCIÓN 5: DESAFÍOS ========== -->
      <section id="desafios" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Desafíos</h2>
        <p class="text-slate-400 text-sm mb-6">Iniciados, completados y tasa de finalización</p>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Desafíos iniciados</p>
            <p class="text-2xl font-bold mt-1" data-kpi="desafios.iniciados">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Desafíos completados</p>
            <p class="text-2xl font-bold text-success mt-1" data-kpi="desafios.completados">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Tasa de finalización</p>
            <p class="text-2xl font-bold text-primary mt-1" data-kpi="desafios.tasaFinalizacion">—</p><span class="text-sm text-slate-500">%</span>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Total usuarios</p>
            <p class="text-2xl font-bold mt-1" data-kpi="resumen.totalUsers">—</p>
          </div>
        </div>
        <div class="mt-6 bg-card-dark rounded-xl p-6 border border-slate-700">
          <h3 class="font-bold mb-4">Completados por desafío (ejemplo)</h3>
          <div class="flex flex-wrap gap-4">
            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-primary"></span><span class="text-sm">7 días · 520 completados</span></div>
            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-info"></span><span class="text-sm">14 días · 312 completados</span></div>
            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-success"></span><span class="text-sm">21 días · 270 completados</span></div>
          </div>
        </div>
      </section>

      <!-- ========== SECCIÓN 6: RECOMPENSAS ========== -->
      <section id="recompensas" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Recompensas y Gamificación</h2>
        <p class="text-slate-400 text-sm mb-6">Cristales, luz cuántica y canjes</p>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Cristales totales (suma usuarios)</p>
            <p class="text-2xl font-bold text-primary mt-1" data-kpi="recompensas.totalCristales">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Usuarios con luz cuántica 100%</p>
            <p class="text-2xl font-bold mt-1" data-kpi="recompensas.usuariosLuz100">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Usuarios con ≥100 cristales</p>
            <p class="text-2xl font-bold text-success mt-1" data-kpi="recompensas.usuariosCon100Cristales">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Total usuarios</p>
            <p class="text-2xl font-bold mt-1" data-kpi="resumen.totalUsers">—</p>
          </div>
        </div>
      </section>

      <!-- ========== SECCIÓN 7: DIARIO Y EVALUACIÓN ========== -->
      <section id="diario" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Diario y Evaluación</h2>
        <p class="text-slate-400 text-sm mb-6">Entradas de diario y completitud de evaluación inicial</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Entradas de diario (últimos 30 días)</p>
            <p class="text-2xl font-bold mt-1" data-kpi="diario.entradas30d">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Usuarios con al menos 1 entrada</p>
            <p class="text-2xl font-bold mt-1" data-kpi="diario.usuariosConEntrada">—</p>
          </div>
          <div class="bg-card-dark rounded-xl p-5 border border-slate-700">
            <p class="text-slate-400 text-sm font-medium">Evaluación inicial completada</p>
            <p class="text-2xl font-bold text-success mt-1" data-kpi="diario.assessmentPct">—</p><span class="text-sm text-slate-500">%</span>
          </div>
        </div>
      </section>
    </main>

    <footer class="border-t border-slate-700 py-6 px-6 mt-8">
      <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4 text-slate-500 text-sm">
        <p>© Panel de KPIs ManiGrab. <span id="footer-data-source">Datos desde Supabase.</span></p>
        <p class="text-xs">Configura <code class="bg-slate-800 px-1 rounded">config.js</code> con tu URL y anon key de Supabase.</p>
      </div>
    </footer>
  </div>

  <script src="config.js"></script>
  <script>
    (function() {
      var SUPABASE_URL = typeof window.SUPABASE_URL !== 'undefined' ? window.SUPABASE_URL : ''
      var SUPABASE_ANON_KEY = typeof window.SUPABASE_ANON_KEY !== 'undefined' ? window.SUPABASE_ANON_KEY : ''

      var MOCK_DATA = {
        resumen: { totalUsers: 0, activeSubscriptions: 0, yearlyCount: 0, monthlyCount: 0 },
        engagement: { sessionsToday: 0, repetitionsTotal: 0, topCodigos: [], topFavoritos: [] },
        calidad: { tasaExitoIA: null, latenciaMedia: null, costoTokens: 0, sugerenciasPendientes: 0, reportesPendientes: 0, sugerenciasLista: [], reportesLista: [] },
        desafios: { iniciados: 0, completados: 0, tasaFinalizacion: 0 },
        recompensas: { totalCristales: 0, usuariosLuz100: 0, usuariosCon100Cristales: 0 },
        diario: { entradas30d: 0, usuariosConEntrada: 0, assessmentPct: 0 }
      }

      function formatNum(n) {
        if (n == null || n === '') return '—'
        if (typeof n === 'number' && (n > 9999 || n < -9999)) return (n / 1000).toFixed(1) + 'k'
        return String(n)
      }

      function setByPath(obj, path, value) {
        var keys = path.split('.')
        var o = obj
        for (var i = 0; i < keys.length - 1; i++) {
          var k = keys[i]
          if (!(k in o)) return
          o = o[k]
        }
        o[keys[keys.length - 1]] = value
      }

      function getByPath(obj, path) {
        var keys = path.split('.')
        var o = obj
        for (var i = 0; i < keys.length; i++) {
          if (o == null) return undefined
          o = o[keys[i]]
        }
        return o
      }

      function updateElements(data) {
        document.querySelectorAll('[data-kpi]').forEach(function(el) {
          var path = el.getAttribute('data-kpi')
          var val = getByPath(data, path)
          if (val === undefined) return
          if (typeof val === 'number' && path.indexOf('Pct') !== -1) el.textContent = val + '%'
          else if (typeof val === 'number') el.textContent = formatNum(val)
          else el.textContent = val == null ? '—' : String(val)
        })
        var topCodigos = data.engagement && data.engagement.topCodigos
        var tbodyCodigos = document.getElementById('tbody-top-codigos')
        if (tbodyCodigos && Array.isArray(topCodigos)) {
          tbodyCodigos.innerHTML = topCodigos.length === 0
            ? '<tr><td colspan="3" class="px-4 py-3 text-slate-500 text-center">Sin datos</td></tr>'
            : topCodigos.map(function(c, i) {
                return '<tr><td class="px-4 py-3 font-bold text-primary">' + (i + 1) + '</td><td class="px-4 py-3">' + (c.codigo || '') + (c.nombre ? ' · ' + c.nombre : '') + '</td><td class="px-4 py-3 text-right">' + formatNum(c.uso) + '</td></tr>'
              }).join('')
        }
        var topFavoritos = data.engagement && data.engagement.topFavoritos
        var tbodyFav = document.getElementById('tbody-top-favoritos')
        if (tbodyFav && Array.isArray(topFavoritos)) {
          tbodyFav.innerHTML = topFavoritos.length === 0
            ? '<tr><td colspan="3" class="px-4 py-3 text-slate-500 text-center">Sin datos</td></tr>'
            : topFavoritos.map(function(f) {
                return '<tr><td class="px-4 py-3">' + (f.codigo || '') + '</td><td class="px-4 py-3"><span class="px-2 py-0.5 bg-primary/20 text-primary rounded text-xs">' + (f.categoria || '') + '</span></td><td class="px-4 py-3 text-right">' + formatNum(f.favoritos) + '</td></tr>'
              }).join('')
        }
        var sugerencias = data.calidad && data.calidad.sugerenciasLista
        var tbodySug = document.getElementById('tbody-sugerencias')
        if (tbodySug && Array.isArray(sugerencias)) {
          tbodySug.innerHTML = sugerencias.length === 0
            ? '<tr><td colspan="2" class="px-4 py-3 text-slate-500 text-center">Ninguna pendiente</td></tr>'
            : sugerencias.map(function(s) {
                return '<tr><td class="px-4 py-3 font-mono text-primary">' + (s.codigo_existente || '') + '</td><td class="px-4 py-3">' + (s.tema_sugerido || '') + '</td></tr>'
              }).join('')
        }
        var reportes = data.calidad && data.calidad.reportesLista
        var tbodyRep = document.getElementById('tbody-reportes')
        if (tbodyRep && Array.isArray(reportes)) {
          tbodyRep.innerHTML = reportes.length === 0
            ? '<tr><td colspan="3" class="px-4 py-3 text-slate-500 text-center">Ninguno pendiente</td></tr>'
            : reportes.map(function(r) {
                return '<tr><td class="px-4 py-3">' + (r.codigo_id || '') + '</td><td class="px-4 py-3">' + (r.tipo_reporte || '') + '</td><td class="px-4 py-3 text-right text-slate-400">' + (r.estatus || '') + '</td></tr>'
              }).join('')
        }
        var total = data.resumen && data.resumen.activeSubscriptions
        if (total != null && total > 0) {
          var yearly = data.resumen.yearlyCount || 0
          var pct = Math.round((yearly / total) * 100)
          var circle = document.getElementById('circle-subscriptions')
          if (circle) {
            var offset = 440 - (440 * pct / 100)
            circle.setAttribute('stroke-dashoffset', Math.max(0, offset))
          }
        }
      }

      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        var url = SUPABASE_URL.replace(/\/$/, '') + '/functions/v1/dashboard-stats'
        var footer = document.getElementById('footer-data-source')
        fetch(url, {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
            'Content-Type': 'application/json',
          },
        })
          .then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status)
            return r.json()
          })
          .then(function(data) {
            if (data.error) {
              console.error('Dashboard API error:', data.error)
              updateElements(MOCK_DATA)
              if (footer) footer.textContent = 'Modo demo. Error Supabase: ' + (data.error || 'desconocido')
              return
            }
            updateElements(data)
            if (footer) footer.textContent = 'Datos en vivo desde Supabase. Última actualización: ' + new Date().toLocaleTimeString('es')
          })
          .catch(function(err) {
            console.error('Fetch error:', err)
            updateElements(MOCK_DATA)
            if (footer) footer.textContent = 'Modo demo. No se pudo conectar a Supabase. ¿Edge Function dashboard-stats desplegada? ¿config.js con URL y anon key correctos?'
          })
      } else {
        updateElements(MOCK_DATA)
        document.getElementById('footer-data-source').textContent = 'Configura config.js (copia config.example.js) con SUPABASE_URL y SUPABASE_ANON_KEY para ver datos reales.'
      }
    })()
  </script>
</body>
</html>
