<!DOCTYPE html>
<html class="dark" lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de KPIs - ManiGrab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;700&display=swap"
    rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#ffd700',
            'bg-dark': '#0B132B',
            'card-dark': '#1C2541',
            success: '#4CAF50',
            alert: '#FF6B6B',
          },
          fontFamily: {
            display: ['Manrope', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'opsz' 24;
    }

    body {
      font-family: 'Manrope', sans-serif;
      background-color: #0B132B;
    }

    #login-screen {
      background-color: #0B132B;
    }
  </style>
</head>

<body class="bg-bg-dark text-white font-display min-h-screen antialiased text-lg">
  <!-- Loading Screen -->
  <div id="loading-overlay"
    class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-bg-dark transition-opacity duration-1000">
    <div class="relative group">
      <!-- Glow Effect Around Logo -->
      <div
        class="absolute inset-0 bg-primary/20 blur-3xl rounded-full scale-150 group-hover:bg-primary/30 transition-all duration-1000 animate-pulse">
      </div>
      <img src="https://manigrab.app/imagenes_pagina/ManiGrab_transparente.png" alt="ManiGrab Logo"
        class="w-32 h-32 relative z-10 animate-bounce mb-8 filter drop-shadow-[0_0_15px_rgba(255,215,0,0.4)]">
    </div>
    <div class="text-center relative z-10">
      <h2 class="text-2xl font-black text-white mb-2 tracking-[0.2em] uppercase">ManiGrab</h2>
      <div class="flex items-center justify-center gap-2">
        <span class="w-1.5 h-1.5 bg-primary rounded-full animate-[bounce_1s_infinite_0ms]"></span>
        <span class="w-1.5 h-1.5 bg-primary rounded-full animate-[bounce_1s_infinite_200ms]"></span>
        <span class="w-1.5 h-1.5 bg-primary rounded-full animate-[bounce_1s_infinite_400ms]"></span>
      </div>
      <p class="text-slate-400 mt-4 text-sm font-medium tracking-wide">estamos preparando tu información</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-bg-dark">
    <div class="w-full max-w-lg bg-card-dark rounded-2xl border border-slate-700 p-10 shadow-2xl">
      <div class="flex flex-col items-center mb-10">
        <img src="https://manigrab.app/imagenes_pagina/ManiGrab_transparente.png" alt="ManiGrab Logo"
          class="w-24 h-24 mb-4 filter drop-shadow-[0_0_10px_rgba(255,215,0,0.3)]">
        <h1 class="text-3xl font-extrabold text-primary tracking-tight">Panel Administrativo</h1>
      </div>
      <div id="login-error"
        class="hidden mb-6 p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-red-500 text-sm text-center">
      </div>
      <form id="login-form" class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Correo Electrónico</label>
          <input type="email" id="email" required
            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-yellow-500 transition-colors"
            placeholder="tu@email.com">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Contraseña</label>
          <input type="password" id="password" required
            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-yellow-500 transition-colors"
            placeholder="••••••••">
        </div>
        <button type="submit" id="login-button"
          class="w-full bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2 mt-2">
          <span>Ingresar al Panel</span>
          <span class="material-symbols-outlined">login</span>
        </button>
      </form>
    </div>
  </div>

  <div id="dashboard-content" class="hidden min-h-screen flex flex-col">
    <!-- Header -->
    <header
      class="sticky top-0 z-50 flex items-center justify-between border-b border-slate-700 bg-bg-dark/95 backdrop-blur px-6 py-3">
      <div class="flex items-center gap-4">
        <img src="https://manigrab.app/imagenes_pagina/ManiGrab_transparente.png" alt="ManiGrab Logo"
          class="w-10 h-10 filter drop-shadow-[0_0_5px_rgba(255,215,0,0.2)]">
        <h1 class="text-xl font-extrabold tracking-tight text-white">ManiGrab <span
            class="text-primary italic">KPIs</span></h1>
      </div>
      <nav class="hidden md:flex flex-wrap items-center gap-4 text-sm">
        <a href="#resumen" class="text-slate-400 hover:text-primary transition-colors">Resumen</a>
        <a href="#engagement" class="text-slate-400 hover:text-primary transition-colors">Engagement</a>
        <a href="#suscripciones" class="text-slate-400 hover:text-primary transition-colors">Suscripciones</a>
        <a href="#calidad" class="text-slate-400 hover:text-primary transition-colors">IA</a>
        <button id="logout-button"
          class="ml-4 px-3 py-1 bg-slate-800 hover:bg-red-500/10 hover:text-red-500 text-slate-400 rounded-lg transition-all text-xs border border-slate-700">Cerrar
          Sesión</button>
      </nav>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full px-6 py-8 space-y-12">
      <!-- ========== SECCIÓN 1: RESUMEN EJECUTIVO ========== -->
      <section id="resumen" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Resumen Ejecutivo</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
          <div role="button" onclick="openModal('usuarios')"
            class="bg-card-dark rounded-xl p-5 border border-slate-700 hover:border-primary/50 transition-all cursor-pointer group">
            <div class="flex justify-between items-start">
              <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Total usuarios</p>
              <span class="material-symbols-outlined text-slate-600 group-hover:text-primary text-sm">visibility</span>
            </div>
            <p class="text-3xl font-bold mt-1" data-kpi="resumen.totalUsers">—</p>
            <p class="text-slate-500 text-xs mt-2">Registrados en la app</p>
          </div>
          <div role="button" onclick="openModal('suscripciones')"
            class="bg-card-dark rounded-xl p-5 border border-slate-700 hover:border-primary/50 transition-all cursor-pointer group">
            <div class="flex justify-between items-start">
              <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Suscripciones Activas</p>
              <span class="material-symbols-outlined text-slate-600 group-hover:text-primary text-sm">visibility</span>
            </div>
            <p class="text-3xl font-bold mt-1" data-kpi="resumen.activeSubscriptions">—</p>
            <p class="text-slate-500 text-xs mt-2">Vigentes (expires_at > hoy)</p>
          </div>
          <div class="bg-card-dark rounded-xl p-6 border border-slate-700">
            <p class="text-slate-400 text-sm font-semibold uppercase tracking-wider">Plan anual</p>
            <p class="text-4xl font-bold text-primary mt-1" data-kpi="resumen.yearlyCount">—</p>
            <p class="text-slate-500 text-sm mt-2">Suscripciones anuales</p>
          </div>
          <div class="bg-card-dark rounded-xl p-6 border border-slate-700">
            <p class="text-slate-400 text-sm font-semibold uppercase tracking-wider">Plan mensual</p>
            <p class="text-4xl font-bold mt-1" data-kpi="resumen.monthlyCount">—</p>
            <p class="text-slate-500 text-sm mt-2">Suscripciones mensuales</p>
          </div>
        </div>
      </section>

      <section id="engagement" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Engagement de Usuarios
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Columna 1: Métricas Apiladas -->
          <div class="flex flex-col gap-4">
            <div role="button" onclick="openModal('engagement_hoy')"
              class="flex-1 bg-card-dark rounded-xl p-5 border border-slate-700 hover:border-primary/50 transition-all cursor-pointer group">
              <div class="flex justify-between items-start">
                <p class="text-slate-400 text-sm font-medium">Sesiones de pilotaje hoy</p>
                <span class="material-symbols-outlined text-slate-600 group-hover:text-primary text-sm">history</span>
              </div>
              <p class="text-3xl font-bold mt-2" data-kpi="engagement.sessionsToday">—</p>
            </div>
            <div role="button" onclick="openModal('engagement_total')"
              class="flex-1 bg-card-dark rounded-xl p-5 border border-slate-700 hover:border-primary/50 transition-all cursor-pointer group">
              <div class="flex justify-between items-start">
                <p class="text-slate-400 text-sm font-medium">Repeticiones totales</p>
                <span class="material-symbols-outlined text-slate-600 group-hover:text-primary text-sm">analytics</span>
              </div>
              <p class="text-3xl font-bold mt-2" data-kpi="engagement.repetitionsTotal">—</p>
            </div>
          </div>

          <!-- Columna 2-3: Gráfico Expandido -->
          <div class="md:col-span-2 bg-card-dark rounded-xl p-5 border border-slate-700 flex flex-col min-h-[250px]">
            <h3 class="text-slate-400 text-xs font-bold uppercase mb-4 tracking-widest text-center">Distribución por
              Categoría (%)</h3>
            <div class="flex flex-1 items-center gap-12 justify-center px-10">
              <div class="relative w-40 h-40 flex-shrink-0">
                <svg id="pie-chart-svg" viewBox="0 0 100 100" class="w-full h-full -rotate-90">
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span class="text-[10px] font-bold text-slate-500 uppercase">Uso</span>
                </div>
              </div>
              <div id="chart-legend" class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2 text-sm max-w-md">
                <p class="text-slate-600 italic">Cargando...</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700">
              <h3 class="font-bold">Top 5 códigos más usados</h3>
            </div>
            <table class="w-full text-sm">
              <thead class="text-slate-400 text-xs uppercase bg-slate-800/50">
                <tr>
                  <th class="px-4 py-2 text-left">#</th>
                  <th class="px-4 py-2 text-left">Código</th>
                  <th class="px-4 py-2 text-right">Uso</th>
                </tr>
              </thead>
              <tbody id="tbody-top-codigos" class="divide-y divide-slate-700">
                <tr>
                  <td colspan="3" class="px-4 py-3 text-slate-500 text-center">Cargando…</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700">
              <h3 class="font-bold">Top códigos en favoritos</h3>
            </div>
            <table class="w-full text-sm">
              <thead class="text-slate-400 text-xs uppercase bg-slate-800/50">
                <tr>
                  <th class="px-4 py-2 text-left">Código</th>
                  <th class="px-4 py-2 text-left">Categoría</th>
                  <th class="px-4 py-2 text-right">Favoritos</th>
                </tr>
              </thead>
              <tbody id="tbody-top-favoritos" class="divide-y divide-slate-700">
                <tr>
                  <td colspan="3" class="px-4 py-3 text-slate-500 text-center">Cargando…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ========== SECCIÓN 3: SUSCRIPCIONES ========== -->
      <section id="suscripciones" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Suscripciones</h2>
        <div class="bg-card-dark rounded-xl p-6 border border-slate-700">
          <h3 class="text-lg font-bold mb-4">Distribución de suscripciones</h3>
          <div class="flex items-center gap-8 text-center sm:text-left">
            <div class="relative w-40 h-40 flex-shrink-0 mx-auto sm:mx-0">
              <svg class="w-full h-full -rotate-90">
                <circle cx="80" cy="80" r="70" fill="none" stroke="#334155" stroke-width="16" />
                <circle id="circle-subscriptions" cx="80" cy="80" r="70" fill="none" stroke="#ffd700"
                  stroke-dasharray="440" stroke-dashoffset="440" stroke-width="16" />
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span class="text-2xl font-bold" data-kpi="resumen.activeSubscriptions">—</span>
                <span class="text-xs text-slate-500">Activos</span>
              </div>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2 font-semibold">
                <span class="w-3 h-3 rounded-full bg-primary"></span>
                <span class="text-sm">Anual: <span data-kpi="resumen.yearlyCount">—</span></span>
              </div>
              <div class="flex items-center gap-2 font-semibold">
                <span class="w-3 h-3 rounded-full bg-slate-600"></span>
                <span class="text-sm">Mensual: <span data-kpi="resumen.monthlyCount">—</span></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Historial de Búsquedas Profundas -->
      <div class="mt-8 bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/30">
          <h3 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">manage_search</span>
            Historial de Búsquedas Profundas (deep_search)
          </h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="text-slate-400 text-xs uppercase bg-slate-800/50">
              <tr>
                <th class="px-4 py-3 text-left">Fecha</th>
                <th class="px-4 py-3 text-left">Tema Buscado</th>
                <th class="px-4 py-3 text-left">Resultado</th>
                <th class="px-4 py-3 text-right">Latencia</th>
                <th class="px-4 py-3 text-right">Costo</th>
              </tr>
            </thead>
            <tbody id="tbody-deep-search" class="divide-y divide-slate-700">
              <tr>
                <td colspan="5" class="px-4 py-8 text-slate-500 text-center">Cargando historial de IA...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      </section>

      <!-- ========== SECCIÓN 5: GESTIÓN DE CÓDIGOS ========== -->
      <section id="codigos" class="scroll-mt-20">
        <h2 class="text-2xl font-extrabold text-primary border-b border-primary/30 pb-2 mb-6">Gestión de Códigos y
          Reportes</h2>
        <div class="grid grid-cols-1 gap-6">
          <div class="bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/30">
              <h3 class="font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-alert">report_problem</span>
                Códigos Reportados por la Comunidad
              </h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-slate-400 text-xs uppercase bg-slate-800/50">
                  <tr>
                    <th class="px-4 py-3 text-left">Código</th>
                    <th class="px-4 py-3 text-left">Motivo / Tipo</th>
                    <th class="px-4 py-3 text-left">Descripción Reportada</th>
                    <th class="px-4 py-3 text-right">Estado</th>
                  </tr>
                </thead>
                <tbody id="tbody-reportes-detalle" class="divide-y divide-slate-700">
                  <tr>
                    <td colspan="4" class="px-4 py-8 text-slate-500 text-center">Buscando reportes activos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="bg-card-dark rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/30">
              <h3 class="font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-success">content_copy</span>
                Posibles Códigos Duplicados o Conflictos
              </h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-slate-400 text-xs uppercase bg-slate-800/50">
                  <tr>
                    <th class="px-4 py-3 text-left">Secuencia</th>
                    <th class="px-4 py-3 text-left">Nombres Detectados (Categorías)</th>
                    <th class="px-4 py-3 text-right">Impacto</th>
                  </tr>
                </thead>
                <tbody id="tbody-duplicados" class="divide-y divide-slate-700">
                  <tr>
                    <td colspan="3" class="px-4 py-8 text-slate-500 text-center">Analizando base de datos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="border-t border-slate-700 py-6 px-6 mt-8">
      <div
        class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4 text-slate-500 text-sm">
        <p>© 2026 ManiGrab Admin · <span id="footer-data-source">Conectando...</span></p>
      </div>
    </footer>
  </div>

  <!-- Modales Detalle -->
  <div id="modal-container"
    class="fixed inset-0 z-[110] hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div
      class="bg-card-dark w-full max-w-4xl max-h-[80vh] rounded-2xl border border-slate-700 flex flex-col shadow-2xl overflow-hidden scale-95 transition-all duration-300"
      id="modal-content">
      <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
        <h3 id="modal-title" class="text-lg font-bold text-primary">Detalles</h3>
        <button onclick="closeModal()"
          class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-500/20 hover:text-red-500 transition-colors">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div id="modal-scrollable" class="flex-1 overflow-auto p-4">
        <table class="w-full text-sm text-left">
          <thead id="modal-thead" class="text-xs uppercase text-slate-400 bg-slate-800/30 sticky top-0">
            <!-- Dinámico -->
          </thead>
          <tbody id="modal-tbody" class="divide-y divide-slate-700">
            <!-- Dinámico -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (function () {
      let currentData = null;

      window.openModal = function (type) {
        if (!currentData) return;
        const modal = document.getElementById('modal-container');
        const title = document.getElementById('modal-title');
        const thead = document.getElementById('modal-thead');
        const tbody = document.getElementById('modal-tbody');
        const content = document.getElementById('modal-content');

        tbody.innerHTML = '';

        if (type === 'usuarios') {
          title.innerHTML = `Usuarios Registrados (${currentData.resumen.totalUsers})`;
          thead.innerHTML = `<tr><th class="px-4 py-2">Nombre / Email</th><th class="px-4 py-2">F. Registro</th><th class="px-4 py-2 text-right">ID</th></tr>`;
          const list = currentData.resumen.usersDetails || [];
          tbody.innerHTML = list.map(u => `
            <tr class="hover:bg-slate-800/40">
              <td class="px-4 py-3"><div class="font-bold">${u.display_name || 'Sin nombre'}</div><div class="text-[10px] text-slate-500">${u.email}</div></td>
              <td class="px-4 py-3 text-xs text-slate-400">${new Date(u.created_at).toLocaleDateString()}</td>
              <td class="px-4 py-3 text-right text-[10px] text-slate-600 font-mono">${u.id.substring(0, 8)}...</td>
            </tr>
          `).join('') || '<tr><td colspan="3" class="p-8 text-center text-slate-500">No hay datos</td></tr>';
        } else if (type === 'suscripciones') {
          title.innerHTML = `Suscripciones Activas (${currentData.resumen.activeSubscriptions})`;
          thead.innerHTML = `<tr><th class="px-4 py-2">Usuario</th><th class="px-4 py-2">Plan</th><th class="px-4 py-2 text-right">Vence</th></tr>`;
          const list = currentData.resumen.subsDetails || [];
          tbody.innerHTML = list.map(s => `
            <tr class="hover:bg-slate-800/40">
              <td class="px-4 py-3"><div class="font-bold font-mono text-xs">${s.email}</div></td>
              <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-[10px] ${s.plan.includes('annual') ? 'bg-primary/20 text-primary border border-primary/30' : 'bg-slate-700 text-slate-300'}">${s.plan}</span></td>
              <td class="px-4 py-3 text-right text-xs font-bold ${new Date(s.expires_at) < new Date() ? 'text-red-400' : 'text-success'}">${new Date(s.expires_at).toLocaleDateString()}</td>
            </tr>
          `).join('') || '<tr><td colspan="3" class="p-8 text-center text-slate-500">No hay datos</td></tr>';
        } else if (type === 'engagement_hoy' || type === 'engagement_total') {
          title.innerHTML = `Historial de Uso Reciente`;
          thead.innerHTML = `<tr><th class="px-4 py-2">Usuario</th><th class="px-4 py-2">Propósito</th><th class="px-4 py-2">Acción</th><th class="px-4 py-2 text-right">Secuencia</th></tr>`;
          const list = currentData.engagement.recentActions || [];
          tbody.innerHTML = list.map(a => `
              <tr class="hover:bg-slate-800/40">
                <td class="px-4 py-3"><div class="font-bold text-xs truncate max-w-[120px]">${a.user}</div><div class="text-[9px] text-slate-600">${new Date(a.fecha).toLocaleTimeString()}</div></td>
                <td class="px-4 py-3 text-xs font-semibold text-slate-300 truncate max-w-[150px]">${a.nombre || '—'}</td>
                <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-[10px] ${a.tipo === 'sesionPilotaje' ? 'bg-success/20 text-success' : 'bg-blue-500/20 text-blue-400'}">${a.tipo}</span></td>
                <td class="px-4 py-3 text-right font-mono text-primary font-bold">${a.codigo || '—'}</td>
              </tr>
            `).join('') || '<tr><td colspan="4" class="p-8 text-center text-slate-500">No hay acciones registradas</td></tr>';
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => content.classList.remove('scale-95'), 10);

        // --- Infinite Scroll Setup (only for engagement) ---
        if (type === 'engagement_hoy' || type === 'engagement_total') {
          historyOffset = 30;
          historyEndReached = false;
          isLoadingExtra = false;
          setupInfiniteScroll();
        } else {
          removeInfiniteScroll();
        }
      }

      let historyOffset = 30; // Empezamos después de los primeros 30 cargados en el init
      const historyLimit = 30;
      let historyEndReached = false;
      let isLoadingExtra = false;

      function setupInfiniteScroll() {
        const scrollable = document.getElementById('modal-scrollable');
        scrollable.onscroll = () => {
          if (historyEndReached || isLoadingExtra) return;
          const { scrollTop, scrollHeight, clientHeight } = scrollable;
          if (scrollTop + clientHeight >= scrollHeight - 50) {
            loadMoreHistory();
          }
        };
      }

      function removeInfiniteScroll() {
        const scrollable = document.getElementById('modal-scrollable');
        if (scrollable) scrollable.onscroll = null;
      }

      async function loadMoreHistory() {
        isLoadingExtra = true;
        const tbody = document.getElementById('modal-tbody');
        const loadingRow = document.createElement('tr');
        loadingRow.id = 'history-loading-row';
        loadingRow.innerHTML = `<td colspan="4" class="p-4 text-center text-primary animate-pulse text-xs uppercase font-bold tracking-widest">Cargando más registros...</td>`;
        tbody.appendChild(loadingRow);

        const api = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        const { data: { session } } = await api.auth.getSession();
        const url = window.SUPABASE_URL.replace(/\/$/, '') + `/functions/v1/dashboard-stats?section=engagement_history&offset=${historyOffset}&limit=${historyLimit}`;

        try {
          const r = await fetch(url, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + session.access_token }
          });
          const data = await r.json();
          const list = data.engagement_history || [];

          const loadingEl = document.getElementById('history-loading-row');
          if (loadingEl) loadingEl.remove();

          if (list.length === 0) {
            historyEndReached = true;
            const endRow = document.createElement('tr');
            endRow.innerHTML = `<td colspan="4" class="p-4 text-center text-slate-500 text-xs italic">Fin del historial</td>`;
            tbody.appendChild(endRow);
          } else {
            list.forEach(a => {
              const row = document.createElement('tr');
              row.className = 'hover:bg-slate-800/40 border-t border-slate-700';
              row.innerHTML = `
                <td class="px-4 py-3"><div class="font-bold text-xs truncate max-w-[120px]">${a.user}</div><div class="text-[9px] text-slate-600">${new Date(a.fecha).toLocaleTimeString()}</div></td>
                <td class="px-4 py-3 text-xs font-semibold text-slate-300 truncate max-w-[150px]">${a.nombre || '—'}</td>
                <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-[10px] ${a.tipo === 'sesionPilotaje' ? 'bg-success/20 text-success' : 'bg-blue-500/20 text-blue-400'}">${a.tipo}</span></td>
                <td class="px-4 py-3 text-right font-mono text-primary font-bold">${a.codigo || '—'}</td>
              `;
              tbody.appendChild(row);
            });
            historyOffset += list.length;
          }
        } catch (err) {
          console.error('Error loading more history:', err);
          const loadingEl = document.getElementById('history-loading-row');
          if (loadingEl) loadingEl.innerHTML = `<td colspan="4" class="p-4 text-center text-red-400 text-xs">Error al cargar más datos</td>`;
        } finally {
          isLoadingExtra = false;
        }
      }

      window.closeModal = function () {
        const modal = document.getElementById('modal-container');
        const content = document.getElementById('modal-content');
        content.classList.add('scale-95');
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }, 200);
      }

      function init() {
        if (!window.supabase) {
          setTimeout(init, 100);
          return;
        }

        const SUPABASE_URL = window.SUPABASE_URL || '';
        const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
        const ADMIN_EMAIL = 'ifernandez@lmsedk.com';

        const api = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const loginScreen = document.getElementById('login-screen');
        const dashboardContent = document.getElementById('dashboard-content');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');

        function showLogin(error = '') {
          loginScreen.classList.remove('hidden');
          dashboardContent.classList.add('hidden');
          if (error) {
            loginError.textContent = error;
            loginError.classList.remove('hidden');
          } else {
            loginError.classList.add('hidden');
          }
        }

        function showDashboard() {
          loginScreen.classList.add('hidden');
          dashboardContent.classList.remove('hidden');
          fetchData();
        }

        async function checkSession() {
          const { data: { session } } = await api.auth.getSession();
          if (session && session.user.email === ADMIN_EMAIL) {
            showDashboard();
          } else {
            showLogin();
          }
        }

        loginForm.onsubmit = async (e) => {
          e.preventDefault();
          loginButton.disabled = true;
          loginButton.innerHTML = '<span>Verificando...</span>';
          loginError.classList.add('hidden');

          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          if (email !== ADMIN_EMAIL) {
            showLogin('Acceso denegado. Solo administradores.');
            loginButton.disabled = false;
            loginButton.innerHTML = '<span>Ingresar al Panel</span>';
            return;
          }

          const { data, error } = await api.auth.signInWithPassword({ email, password });

          if (error) {
            showLogin('Error: ' + error.message);
          } else {
            showDashboard();
          }
          loginButton.disabled = false;
          loginButton.innerHTML = '<span>Ingresar al Panel</span>';
        };

        logoutButton.onclick = async () => {
          await api.auth.signOut();
          window.location.reload();
        };

        function formatNum(n) {
          if (n == null || n === '') return '—'
          if (typeof n === 'number' && (n > 9999 || n < -9999)) return (n / 1000).toFixed(1) + 'k'
          return String(n)
        }

        function getByPath(obj, path) {
          return path.split('.').reduce((o, k) => (o || {})[k], obj);
        }

        function updateElements(data) {
          // Actualizar gráfico de categorías (Pie Chart)
          const svg = document.getElementById('pie-chart-svg');
          const legend = document.getElementById('chart-legend');
          if (svg && legend && data.engagement?.categoriesComparison) {
            const list = data.engagement.categoriesComparison;
            const total = list.reduce((a, b) => a + b.value, 0);
            const colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];

            let currentOffset = 0;
            svg.innerHTML = '';
            legend.innerHTML = '';

            list.forEach((c, i) => {
              const pct = (c.value / total) * 100;
              const color = colors[i % colors.length];

              // Círculo SVG (Stroke-dasharray para el arco)
              const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
              circle.setAttribute("cx", "50");
              circle.setAttribute("cy", "50");
              circle.setAttribute("r", "40");
              circle.setAttribute("fill", "transparent");
              circle.setAttribute("stroke", color);
              circle.setAttribute("stroke-width", "12");
              circle.setAttribute("stroke-dasharray", `${pct * 2.51} 251.2`);
              circle.setAttribute("stroke-dashoffset", `-${currentOffset * 2.51}`);
              circle.classList.add("transition-all", "duration-1000");
              svg.appendChild(circle);

              // Leyenda
              legend.innerHTML += `
              <div class="flex justify-between items-center group py-0.5">
                <div class="flex items-center gap-3 truncate">
                  <div class="w-3 h-3 rounded-full flex-shrink-0" style="background: ${color}"></div>
                  <span class="text-slate-300 font-semibold truncate text-xs">${c.name}</span>
                </div>
                <span class="text-primary font-bold ml-2 text-xs">${Math.round(pct)}%</span>
              </div>
            `;

              currentOffset += pct;
            });
          }

          document.querySelectorAll('[data-kpi]').forEach(el => {
            const path = el.getAttribute('data-kpi');
            const val = getByPath(data, path);
            if (val === undefined) return;
            if (typeof val === 'number' && path.includes('Pct')) el.textContent = val + '%';
            else if (typeof val === 'number') el.textContent = formatNum(val);
            else el.textContent = val == null ? '—' : String(val);
          });

          const renderTable = (id, list, mapFn, emptyMsg) => {
            const tbody = document.getElementById(id);
            if (!tbody) return;
            tbody.innerHTML = (!list || list.length === 0)
              ? `<tr><td colspan="10" class="px-4 py-3 text-slate-500 text-center">${emptyMsg}</td></tr>`
              : list.map(mapFn).join('');
          };

          renderTable('tbody-top-codigos', data.engagement?.topCodigos, (c, i) =>
            `<tr><td class="px-4 py-3 font-bold text-primary">${i + 1}</td><td class="px-4 py-3 text-xs">${c.codigo || ''}<br><span class="text-slate-500">${c.nombre || ''}</span></td><td class="px-4 py-3 text-right">${formatNum(c.uso)}</td></tr>`,
            'Sin datos');

          renderTable('tbody-top-favoritos', data.engagement?.topFavoritos, f =>
            `<tr><td class="px-4 py-3 text-xs">${f.codigo || ''}</td><td class="px-4 py-3"><span class="px-2 py-0.5 bg-primary/20 text-primary rounded text-[10px]">${f.categoria || ''}</span></td><td class="px-4 py-3 text-right">${formatNum(f.favoritos)}</td></tr>`,
            'Sin datos');

          renderTable('tbody-deep-search', data.calidad?.searchesHistory, s =>
            `<tr>
              <td class="px-4 py-3 text-[10px] text-slate-500 font-mono">${new Date(s.created_at).toLocaleString()}</td>
              <td class="px-4 py-3 text-xs font-semibold">${s.query || ''}</td>
              <td class="px-4 py-3"><span class="px-2 py-0.5 ${s.codigo_encontrado ? 'bg-success/20 text-success' : 'bg-alert/20 text-alert'} rounded text-[10px]">${s.codigo_encontrado ? 'Éxito' : 'Sin éxito'}</span></td>
              <td class="px-4 py-3 text-right text-xs font-mono">${s.duracion_ms || 0}ms</td>
              <td class="px-4 py-3 text-right text-xs text-primary">$${s.costo_estimado || 0}</td>
            </tr>`,
            'No hay búsquedas recientes');

          renderTable('tbody-reportes-detalle', data.calidad?.reportesLista, r =>
            `<tr>
              <td class="px-4 py-3 text-xs font-bold text-primary">${r.codigo_id || ''}</td>
              <td class="px-4 py-3 text-xs">${r.tipo_reporte || ''}</td>
              <td class="px-4 py-3 text-xs italic text-slate-400">"${r.descripcion || 'Sin descripción'}"<br><span class="text-[9px] not-italic text-slate-600">${new Date(r.fecha).toLocaleDateString()}</span></td>
              <td class="px-4 py-3 text-right"><span class="px-2 py-0.5 ${r.estatus === 'pendiente' ? 'bg-alert/20 text-alert' : 'bg-slate-700 text-slate-300'} rounded text-[10px]">${r.estatus || 'pendiente'}</span></td>
            </tr>`,
            'No hay reportes ni sugerencias pendientes');

          renderTable('tbody-duplicados', data.calidad?.duplicates, d =>
            `<tr>
              <td class="px-4 py-3 text-sm font-mono font-bold text-primary">${d.codigo}</td>
              <td class="px-4 py-3 text-xs">${d.nombres.join(', ')}</td>
              <td class="px-4 py-3 text-right">
                <div class="text-[9px] text-slate-500 mb-1 font-bold uppercase">${d.tipo}</div>
                <span class="px-2 py-1 bg-yellow-500/10 text-yellow-500 border border-yellow-500/30 rounded text-[10px] font-bold">${d.count} refs</span>
              </td>
            </tr>`,
            'No se detectaron conflictos de integridad en los códigos');

          const total = data.resumen?.activeSubscriptions;
          if (total && total > 0) {
            const yearly = data.resumen.yearlyCount || 0;
            const pct = Math.round((yearly / total) * 100);
            const circle = document.getElementById('circle-subscriptions');
            if (circle) circle.setAttribute('stroke-dashoffset', 440 - (440 * pct / 100));
          }
        }

        async function fetchData() {
          const loading = document.getElementById('loading-overlay');
          if (loading) loading.style.opacity = '1';
          if (loading) loading.classList.remove('hidden');

          const { data: { session } } = await api.auth.getSession();
          if (!session) {
            if (loading) loading.classList.add('hidden');
            return;
          }
          const url = SUPABASE_URL.replace(/\/$/, '') + '/functions/v1/dashboard-stats';
          const footer = document.getElementById('footer-data-source');
          try {
            const r = await fetch(url, {
              method: 'GET',
              headers: { 'Authorization': 'Bearer ' + session.access_token, 'Content-Type': 'application/json' },
            });
            const data = await r.json();
            if (data.error) throw new Error(data.error);
            currentData = data;
            updateElements(data);
            if (footer) footer.textContent = 'Datos en vivo: ' + session.user.email;
          } catch (err) {
            console.error(err);
            if (footer) footer.textContent = 'Error: ' + err.message;
          } finally {
            if (loading) {
              loading.style.opacity = '0';
              setTimeout(() => loading.classList.add('hidden'), 500);
            }
          }
        }
        checkSession();
      }
      init();
    })();
  </script>
</body>

</html>